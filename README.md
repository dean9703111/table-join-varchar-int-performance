# å¯¦é©— Table Join æ™‚ï¼Œé¸æ“‡æ–‡å­—æ¬„ä½ï¼ˆVARCHARï¼‰èˆ‡æ•¸å€¼æ¬„ä½ï¼ˆINTï¼‰åœ¨æ•ˆèƒ½ï¼ˆperformanceï¼‰ä¸Šçš„å·®ç•°ã€‚

å› ç‚ºå‰›å¥½æœ‹å‹åœ¨å°ˆæ¡ˆçš„æœå°‹ä¸Šé‡åˆ°æ•ˆèƒ½ç“¶é ¸ï¼Œåœ¨çœ‹éç¨‹å¼ç¢¼å¾Œï¼Œç™¼ç¾ä»–åœ¨ Table åš Join æ™‚éƒ½æ˜¯æŒ‘é¸æ–‡å­—æ¬„ä½ï¼Œå› æ­¤ç ”åˆ¤é€™æ‡‰è©²å°±æ˜¯å°è‡´æ•ˆç‡ä½ä¸‹çš„ä¸»è¦åŸå› ï¼›ç‚ºäº†å¯¦é©—æ–‡å­—æ¬„ä½ï¼ˆVARCHARï¼‰èˆ‡æ•¸å€¼æ¬„ä½ï¼ˆINTï¼‰åœ¨ Join æ™‚çš„æ•ˆèƒ½å·®ç•°ï¼Œç‰¹åˆ¥æ’°å¯«äº†é€™ç¯‡æ–‡ç« ï¼Œä½†å¯¦é©—çš„çµæœå®Œå…¨ä¸åœ¨æˆ‘çš„æ„æ–™ä¹‹å…§...

### å¤§ç¶±

- ä¸€ã€æƒ…å¢ƒèªªæ˜
- äºŒã€å»ºç«‹æ¸¬è©¦ DBã€Table
- ä¸‰ã€è¨­è¨ˆï¼†å»ºç«‹æ¨¡æ“¬è³‡æ–™
- å››ã€å¯¦é©—æ–‡å­—æ¬„ä½ï¼ˆVARCHARï¼‰èˆ‡æ•¸å€¼æ¬„ä½ï¼ˆINTï¼‰åœ¨ Join æ™‚çš„å·®ç•°
- äº”ã€ä»¤äººæ„å¤–çš„ç¸½çµ

# ä¸€ã€æ¨¡æ“¬æƒ…å¢ƒèªªæ˜

å‡è¨­ä¸€å€‹å•†åŸç³»çµ±ï¼š

- æœ‰ 1W å€‹é¡§å®¢
- æ¯ä½é¡§å®¢æœ‰ 10 ç­†è¨‚å–®ï¼ˆ10W ç­†è¨‚å–®ï¼‰
- æ¯ç­†è¨‚å–®æœ‰ 10 ç­†è³¼è²·çš„å•†å“ï¼ˆ100W ç­†è³¼è²·çš„å•†å“ï¼‰

å¦‚æœä»Šå¤©æƒ³è¦æœå°‹æŸå€‹åƒ¹æ ¼å€é–“çš„ã€Œå•†å“ã€ï¼Œæœ‰å“ªäº›ã€Œä½¿ç”¨è€…ã€è³¼è²·ï¼›ä½¿ç”¨æ–‡å­—æ¬„ä½ï¼ˆexï¼šVARCHARã€CHARï¼‰èˆ‡æ•¸å€¼æ¬„ä½ï¼ˆexï¼šINTï¼‰ï¼Œåœ¨æ•ˆèƒ½ä¸Šå¯¦éš›æœƒæœ‰å¤šå°‘å·®ç•°ã€‚

---

# äºŒã€å»ºç«‹æ¸¬è©¦ DBã€Table

å¦‚æœæƒ³çŸ¥é“è©³ç´°çš„ç¨‹å¼ï¼Œæˆ–æ˜¯æ‰“ç®—åœ¨ Local ç«¯æ¨¡æ“¬ä¸€æ¨£çš„ç’°å¢ƒï¼Œå¤§å®¶å¯ä»¥åƒè€ƒæˆ‘åœ¨[GitHub ä¸Šé¢çš„å°ˆæ¡ˆ](https://github.com/dean9703111/table-join-varchar-int-performance)

DB æˆ‘é¸æ“‡çš„æ˜¯ MySQLï¼Œè€Œ Table çš„è¨­è¨ˆå¦‚ä¸‹ï¼š

- usersï¼ˆé¡§å®¢ï¼‰
  | Column | Type | Des |
  |----------|---------|---------|
  | id | INTEGER | è‡ªå‹•æˆé•·çš„ id |
  | name | STRING | å§“å |
  | mail | STRING | mail |

- ordersï¼ˆè¨‚å–®ï¼‰
  | Column | Type | Des |
  |----------|---------|---------|
  | id | INTEGER | è‡ªå‹•æˆé•·çš„ id |
  | sn | STRING | çµ¦äººçœ‹çš„è¨‚å–®åºè™Ÿ |
  | user_id | INTEGER | å°æ‡‰é¡§å®¢(user) çš„ id |
  | user_name | STRING | å°æ‡‰é¡§å®¢(user) çš„ name |

  è¨­è¨ˆã€Œuser_idã€user_nameã€æ˜¯ç‚ºäº†å°æ¯”æ–‡å­—æ¬„ä½ï¼ˆexï¼šVARCHARï¼‰èˆ‡æ•¸å€¼æ¬„ä½ï¼ˆexï¼šINTï¼‰çš„å·®ç•°ã€‚

- itemsï¼ˆè³¼è²·çš„å•†å“ï¼‰
  | Column | Type | Des |
  |----------|---------|---------|
  | id | INTEGER | è‡ªå‹•æˆé•·çš„ id |
  | name | STRING | å•†å“åç¨± |
  | price | INTEGER | å•†å“åƒ¹æ ¼ |
  | order_id | INTEGER | å°æ‡‰è¨‚å–®(order) çš„ id |
  | order_sn | STRING | å°æ‡‰è¨‚å–®(order) çš„ sn |

  è¨­è¨ˆã€Œorder_idã€order_snã€æ˜¯ç‚ºäº†å°æ¯”æ–‡å­—æ¬„ä½ï¼ˆexï¼šVARCHARï¼‰èˆ‡æ•¸å€¼æ¬„ä½ï¼ˆexï¼šINTï¼‰çš„å·®ç•°ã€‚

å¯ç”¨å¦‚ä¸‹æŒ‡ä»¤å»ºç«‹è³‡æ–™ï¼š

- Clone å°ˆæ¡ˆï¼š`git clone git@github.com:dean9703111/table-join-varchar-int-performance.git`
- å®‰è£å¥—ä»¶ï¼š`npm install`
- å®‰è£ sequelize cliï¼š`npm install -g sequelize-cli`
- å°‡ config è³‡æ–™å¤¾åº•ä¸‹çš„ config.exmaple.json è¤‡è£½ç‚º config.jsonï¼Œä¸¦å¡«å…¥è‡ªå·±çš„ DB è³‡è¨Š
- å»ºç«‹ DBï¼š`sequelize db:create`
- åŸ·è¡Œ migration å»ºç«‹ Tablesï¼š`sequelize db:migrate`

> è³‡æ–™éƒ½æ˜¯ä½¿ç”¨ Node.js æ­é… sequelize é€™æ¬¾å¥—ä»¶ä¾†å»ºç«‹çš„ï¼Œå¦‚æœæƒ³äº†è§£è©³ç´°ä½¿ç”¨æ–¹å¼ï¼Œå¯ä»¥åƒè€ƒæˆ‘å…ˆå‰çš„çš„[æ–‡ç« ]()

![image](img/db-migration.png)

ä¸‹åœ–æ˜¯ç”¨ MySQLWorkbench ç”¢ç”Ÿçš„ ER Diagram

![image](img/er-diagram.png)

---

# ä¸‰ã€è¨­è¨ˆï¼†å»ºç«‹æ¨¡æ“¬è³‡æ–™

æˆ‘å€‘éœ€è¦è¨­è¨ˆ 3 å€‹ Seederï¼Œå°‡æœŸæœ›çš„è³‡æ–™å¡å…¥

**STEP 1**ï¼šå»ºç«‹ 1W å€‹é¡§å®¢
**STEP 2**ï¼šç‚ºæ¯ä½é¡§å®¢å»ºç«‹ 10 ç­†è¨‚å–®ï¼ˆuser_idã€user_name éœ€èˆ‡ user Table é—œè¯ï¼‰
**STEP 3**ï¼šç‚ºæ¯ç­†è¨‚å–®å»ºç«‹ 100 ç­†è³¼è²·çš„å•†å“ï¼ˆorder_idã€order_sn éœ€èˆ‡ order Table é—œè¯ï¼‰

åŸ·è¡Œå…¨éƒ¨ Seeder
```
sequelize db:seed:all
```
![image](img/excute-seeder.png)

**STEP 4**ï¼šå‰å¾€ DB ï¼Œç¢ºèªè³‡æ–™æ˜¯å¦æœ‰æ­£ç¢ºå¯«å…¥
- users Table
  ![image](img/user-table.png)
- orders Table
  ![image](img/order-table.png)
- items Table
  ![image](img/item-table.png)

---

# å››ã€æ¯”å°æ–‡å­—æ¬„ä½ï¼ˆVARCHARï¼‰èˆ‡æ•¸å€¼æ¬„ä½ï¼ˆINTï¼‰åœ¨ Join æ™‚çš„å·®ç•°

**STEP 1**ï¼šæ’°å¯«æ¸¬è©¦ç¨‹å¼

åœ¨è³‡æ–™å»ºç«‹å®Œå¾Œï¼Œæˆ‘å€‘é€éä¸‹é¢å¹¾ç¨®æƒ…å¢ƒä¾†çœ‹çœ‹å¯¦éš›ä¸Šçš„æ•ˆèƒ½å·®ç•°ï¼š

1. ç”¨æ•¸å€¼æ¬„ä½ï¼ˆINTï¼‰Joinï¼Œæœå°‹å–®ç­†è³‡è¨Šï¼š`joinIntFindOne()`
2. ç”¨æ•¸å€¼æ¬„ä½ï¼ˆINTï¼‰Joinï¼Œè¨­å®šæ¢ä»¶æœå°‹å¤§é‡è³‡è¨Šï¼š`joinIntSearchRange()`
3. ç”¨æ–‡å­—æ¬„ä½ï¼ˆVARCHARï¼‰Joinï¼Œæœå°‹å–®ç­†è³‡è¨Šï¼š`joinVarcharFindOne()`
4. ç”¨æ–‡å­—æ¬„ä½ï¼ˆVARCHARï¼‰Joinï¼Œè¨­å®šæ¢ä»¶æœå°‹å¤§é‡è³‡è¨Šï¼š`joinVarcharSearchRange()`

**STEP 2**ï¼šæ¸¬è©¦ä¸¦å–å¾—çµæœ

çµæœåŸ·è¡Œçš„çµæœå®Œå…¨ä¸åœ¨æˆ‘æƒ³åƒç¯„åœä¹‹å…§ï¼Œåœ¨ä¸‹åœ–ä¸­å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œç„¡è«–æ˜¯ç”¨æ–‡å­—æ¬„ä½ï¼ˆVARCHARï¼‰é‚„æ˜¯æ•¸å€¼æ¬„ä½ï¼ˆINTï¼‰ä¾†åšJoinï¼Œæœå°‹å‡ºä¾†çš„é€Ÿåº¦å±…ç„¶ç›¸å·®ç„¡å¹¾ï¼Œé€™å€‹çµæœæœ‰é»é¡›è¦†æˆ‘éå»çš„èªçŸ¥ã€‚

![image](img/query-100-postive.png)

**STEP 3**ï¼šå»ºç«‹åå‘çš„è³‡æ–™ä¾†åšæ¸¬è©¦

ä½ ä»¥ç‚ºæˆ‘å°±æœƒè‡£æœæ–¼é€™å€‹å¯¦ç¾çµæœå—ï¼Ÿä¸ï¼æˆ‘è¦å†åšä¸€å€‹æ¸¬è©¦ï¼

æ”¹è®Šå¦‚ä¸‹åƒæ•¸ï¼š
1. åœ¨å»ºç«‹è¨‚å–®ï¼ˆorderï¼‰çš„ Seeder æ™‚ï¼Œæ•…æ„å°‡ user_idã€name åå‘æ’åº
1. åœ¨å»ºç«‹è¨‚å–®ï¼ˆitemï¼‰çš„ Seeder æ™‚ï¼Œæ•…æ„å°‡ order_idã€sn åå‘æ’åº

> ä¸Šè¿°å¯é€éèª¿æ•´ .env çš„ CREATE_TABLE_SORT ä¾†è¨­å®šè¦æ­£å‘ï¼ˆpostiveï¼‰é‚„æ˜¯åå‘ï¼ˆreverseï¼‰

é€éå¦‚ä¸‹æŒ‡ä»¤å°‡ DBã€Table é‡å»ºï¼Œä¸¦é‡æ–°åŸ·è¡Œ Migrationã€Seeder
```
sequelize db:migrate:undo:all
sequelize db:migrate
sequelize db:seed:all
```

èª¿æ•´å¾Œçš„ ordersã€items çš„ Table å…§å®¹
![image](img/order-reverse-table.png)
![image](img/item-reverse-table.png)

**STEP 4**ï¼šæ¸¬è©¦åå‘çš„è³‡æ–™å°æœå°‹æ•ˆèƒ½çš„å½±éŸ¿

åŸ·è¡Œç¨‹å¼å¾Œçš„çµæœè®“æˆ‘éå¸¸æ„å¤–ğŸ˜±ğŸ˜±ğŸ˜±ï¼Œå±…ç„¶å…©è€…å¯¦éš›èŠ±è²»çš„æ™‚é–“æ˜¯å·®ä¸å¤šçš„ğŸ˜«
![image](img/query-100-reverse.png)

# äº”ã€ä»¤äººæ„å¤–çš„ç¸½çµ

è€å¯¦èªªï¼Œæˆ‘å®Œå…¨æ²’æƒ³åˆ°å¯¦é©—çš„çµæœï¼›å› ç‚ºåœ¨æˆ‘éå¾€çš„èªçŸ¥ä¸­ï¼Œå…©è€…çš„æ‰€éœ€èŠ±è²»çš„æ™‚é–“å·®ç•°æ‡‰è©²æœƒç›¸ç•¶å¤§ã€‚

ç•¶ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯å› ç‚ºæˆ‘çš„å¯¦é©—æƒ…å¢ƒä¸å¤ å®Œå–„ã€æŸ¥è©¢æ•¸é‡ä¸å¤ æ‰€å°è‡´

> ç­†è€…æœ‰å˜—è©¦å°‡ item æ•¸é‡å¢åŠ åˆ° 1000W ç­†ï¼Œä½†å¯¦é©—çš„çµæœé‚„æ˜¯å·®ä¸å¤šğŸ’€

ç•¶ç„¶å¯¦å‹™ä¸Šé‚„æ˜¯å»ºè­°ç”¨æ•¸å€¼æ¬„ä½ï¼ˆINTï¼‰ä¾†åš Joinï¼Œå¾æ¼”ç®—æ³•çš„é‚è¼¯ä¾†è¬›æœƒæ›´çœç©ºé–“ï¼Œæ–‡å­—æ¬„ä½ï¼ˆVARCHARï¼‰ä¸»è¦çš„ä½œç”¨é‚„æ˜¯çµ¦ä½¿ç”¨è€…è§€çœ‹çš„ã€‚

å¦‚æœå°å¯¦é©—æœ‰å…¶ä»–çš„å»ºè­°ï¼Œä¹Ÿæ­¡è¿å¤§å®¶ç•™è¨€ï¼Œç­†è€…ç›¸ä¿¡è¨è«–èƒ½å¢é€²å½¼æ­¤çš„æˆé•·ã€‚

> æœ¬ç¯‡æ˜¯å¾ã€Œæœå°‹èŠ±è²»æ™‚é–“ã€çš„è§’åº¦ä¾†å¯¦é©—ï¼Œæ­¡è¿é«˜æ‰‹å¾ç¡¬é«”æ¶ˆè€—è³‡æºçš„è§’åº¦ä¾†å¯¦é©—ã€‚

### é—œè¯å°ˆæ¡ˆ

1. [sequelize-mysql-migration-seeder](https://github.com/dean9703111/sequelize-mysql-migration-seeder)
